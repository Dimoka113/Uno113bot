
from telegram import ParseMode, InlineKeyboardMarkup, \
    InlineKeyboardButton, Update

from telegram import ParseMode, Update
from telegram.ext import CommandHandler, CallbackContext
from asyncio import sleep
from user_setting import UserSetting
from utils import send_async
from shared_vars import dispatcher
from internationalization import _, user_locale
from contextlib import suppress
import subprocess
import time

ADMIN = 943441135


@user_locale
def help_handler(update: Update, context: CallbackContext):
    """Handler for the /help command"""
    help_text = _(
"""<b>–°–ª–µ–¥—É–π—Ç–µ —ç—Ç–∏–º —à–∞–≥–∞–º:</b>
1. –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
2. –í –≥—Ä—É–ø–ø–µ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É —Å –ø–æ–º–æ—â—å—é /new –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã —Å /join
¬´3. –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—Å—è –∫–∞–∫ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –∏–≥—Ä–æ–∫–∞, –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É —Å –ø–æ–º–æ—â—å—é¬ª
/go
4. –í–≤–µ–¥–∏—Ç–µ <code>@uno113bot</code> –≤ –æ–∫–Ω–æ —á–∞—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ <b>–ø—Ä–æ–±–µ–ª</b>. 
–í—ã —É–≤–∏–¥–∏—Ç–µ —Å–≤–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö –≤—ã–¥–µ–ª–µ–Ω—ã —Å–µ—Ä—ã–º —Ü–≤–µ—Ç–æ–º), 
–ª—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∏ <b>?</b>, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å 
—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã. <b>—Å–µ—Ä—ã–µ –∫–∞—Ä—Ç—ã</b> - —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã 
<b>–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</b> –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç. 
–ö–æ—Å–Ω–∏—Ç–µ—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å 
–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.
–ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è. (–ï—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫—Ä—ã—Ç–∞)
–ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /leave. 
–ï—Å–ª–∏ –∏–≥—Ä–æ–∫—É —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ 90 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å, 
–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /skip, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞. 
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /notify_me, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã.


<b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
/stats - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä
/delstats - –£–¥–∞–ª–∏—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä

<b>–î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã):</b>
/close - –ó–∞–∫—Ä—ã—Ç—å –ª–æ–±–±–∏
/open - –û—Ç–∫—Ä—ã—Ç—å –ª–æ–±–±–∏
/kill - –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
/kick - –í—ã–≥–Ω–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–∑ –∏–≥—Ä—ã 
(–û—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)""")

    send_async(context.bot, update.message.chat_id, text=help_text,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)



@user_locale
def modes(update: Update, context: CallbackContext):
    """Handler for the /help command"""
    modes_explanation = _(
"""–£ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ UNO –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∂–∏–º–æ–≤ –∏–≥—Ä—ã:
üéª–í –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO –∏ –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üî¢–í \"<b>—Ü–∏—Ñ—Ä–æ–º</b>\" —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ UNO –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç –∏ –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üîÅ–í \"<b>—Ä–µ–≤–µ—Ä—Å–∏–≤–Ω–æ–º</b>\" —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO, –Ω–æ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–µ—Ä–µ–≤—ë–Ω—É—Ç—ã, –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üéª–í –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO –∏ –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üöÄ–í —Ä–µ–∂–∏–º–µ \"<b>–±—ã—Å—Ç—Ä—ã–π</b>\" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO, –∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä–æ–∫–∞, –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∏–≥—Ä–∞–µ—Ç —Å–≤–æ–π —Ö–æ–¥
üêâ–í —Ä–µ–∂–∏–º–µ \"<b>–¥–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞</b>\" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç, –º–µ–Ω—å—à–∏–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ–º —á–∏—Å–µ–ª –∏ –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üî•üêâ–í —Ä–µ–∂–∏–º–µ \"<b>–æ–ø–∞—Å–Ω–∞—è –¥–∏–∫–∞—è –ø—Ä–∏—Ä–æ–¥–∞\"</b> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ —Å–æ—Å—Ç–æ—è—â–∞—è —Ç–æ–ª—å–∫–æ –∏–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç.
üåé–í —Ä–µ–∂–∏–º–µ <b>\"–±–æ–ª—å—à–æ–π –º–∏—Ä\"</b> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO, –Ω–æ –≤ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –≤–∞–º –≤—ã–¥–∞—ë—Ç—Å—è <b>–û–ß–ï–ù–¨</b> –º–Ω–æ–≥–æ –∫–∞—Ä—Ç.
üåéüêâ–í —Ä–µ–∂–∏–º–µ <b>\"–±–æ–ª—å—à–æ–π –¥–∏–∫–∏–π –º–∏—Ä\"</b> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç, –≤ –Ω–∞—á–∞–ª–µ –≤–∞–º –≤—ã–¥–∞—ë—Ç—Å—è –ë–û–õ–¨–®–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç. –ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞.
üåé‚öôÔ∏è–í —Ä–µ–∂–∏–º–µ <b>\"–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –º–∏—Ä\"</b> –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO, –Ω–æ –≤ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –≤–∞–º –≤—ã–¥–∞—ë—Ç—Å—è —Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —É–∫–∞–∑–∞–ª–∏. (–ú–∞–∫—Å–∏–º—É–º 35)
ü™ê–í —Ä–µ–∂–∏–º–µ \"<b>—Ä–∞–Ω–¥–æ–º–Ω–æ–º –º–∏—Ä</b>\" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω–∞—è –∫–æ–ª–æ–¥–∞ UNO, –Ω–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ö–æ–¥–µ, –∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–æ–≤ –º–µ–Ω—è—é—Ç—Å—è!
(<b>–¢–∞–∫-–∂–µ –∫–∞–∂–¥—ã–π –∏–∑ —ç—Ç–∏—Ö —Ä–µ–∂–∏–º–æ–≤ –∏–º–µ–µ—Ç —Å–≤–æ—é —Ç–µ–∫—Å—Ç–æ–≤—É—é –≤–µ—Ä—Å–∏—é ‚úçÔ∏è</b>)


<b><i>–£—á–∏—Ç–∏—Ç–µ, –µ—Å–ª–∏ –≤—ã –Ω–∞–±–µ—Ä—ë—Ç–µ –±–æ–ª—å—à–µ 45 –∫–∞—Ä—Ç –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–µ—Ç–µ!</i></b>
–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º –∏–≥—Ä—ã, –°–û–ó–î–ê–¢–ï–õ–Æ –ò–ì–†–´ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º –±–æ—Ç–∞ –∏ –ø—Ä–æ–±–µ–ª,
—Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ø—Ä–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –∫–∞—Ä—Ç—ã, –∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞.
<i>(–ò–ª–∏ –∂–µ –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∏–≥—Ä—ã)</i>
""")
    
    send_async(context.bot, update.message.chat_id, text=modes_explanation,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)

@user_locale
def source(update: Update, context: CallbackContext):
    """Handler for the /help command"""
    source_text = _('–≠—Ç–æ—Ç –±–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∫–æ–ø–∏–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è. –ò –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π "<b>AGPL</b>".\n'
      "<b>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –∑–¥–µ—Å—å:</b> \n"
      "https://github.com/jh0ker/mau_mau_bot")
    attributions = _("–ê—Ç—Ä–∏–±—É—Ü–∏–∏:\n"
      '"<b>Draw" –∑–Ω–∞—á–æ–∫ –æ—Ç:</b> '
      '<a href="http://www.faithtoken.com/">Faithtoken</a>\n'
      '"<b>Pass" –∑–Ω–∞—á–æ–∫ –æ—Ç:</b> '
      '<a href="http://delapouite.com/">Delapouite</a>\n'
      "–û—Ä–∏–≥–∏–Ω–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞: http://game-icons.net\n"
      "–ò–∫–æ–Ω–∫–∏, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ <b>…≥ick</b>\n"
      "–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π, <a href='https://www.unorules.com/uno-flip-rules/'>uno flip</a> –∏ –æ—Ç–ª–∞–¥–∫–∞: <a href='https://t.me/This113bots'>This113bots</a>\n"
      "–û—Ç–¥–µ–ª—å–Ω–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å : <a href='tg://user?id=1956508438'>MrKoteyka</a>")

    send_async(context.bot, update.message.chat_id, text=source_text + '\n' +
                                                 attributions,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)


@user_locale
def news(update: Update, context: CallbackContext):
    """Handler for the /news command"""
    chat = update.message.chat
    ping = [[InlineKeyboardButton(text=_("üë®‚ÄçüíªThis113bots"), url='https://t.me/This113bots')]]
    send_async(context.bot, chat.id,      
                    text=_("–ù–æ–≤–æ—Å—Ç–∏ –ø–æ –±–æ—Ç–∞–º –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—á–∏—Ç–∞—Ç—å —Ç—É—Ç üëá"),
                      reply_markup=InlineKeyboardMarkup(ping),
                      parse_mode=ParseMode.HTML)

  
@user_locale
def stats(update: Update, context: CallbackContext):
    user = update.message.from_user
    chat = update.message.chat
    us = UserSetting.get(id=user.id)
    if not us or not us.stats:
          ping = [[InlineKeyboardButton(text=_("–í–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!"), url='https://t.me/Uno113bot?start=stats_add')]]
          send_async(context.bot, chat.id,      
                    text=_("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ —Å –±–æ—Ç–æ–º."),
                      reply_to_message_id=update.message.message_id,
                      reply_markup=InlineKeyboardMarkup(ping),
                      parse_mode=ParseMode.HTML)

    else:
        stats_text = list()

        n = us.games_played
        stats_text.append(
            _("–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: {number}",
              "–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: {number}",
              n).format(number=n)
        )

        n = us.first_places
        m = round((us.first_places / us.games_played) * 100) if us.games_played else 0
        stats_text.append(
            _("–í—ã–∏–≥—Ä–∞–Ω–æ –∏–≥—Ä: {number}. ({percent}%)",
              "–í—ã–∏–≥—Ä–∞–Ω–æ –∏–≥—Ä: {number}. ({percent}%)",
              n).format(number=n, percent=m)
        )

        n = us.cards_played
        stats_text.append(
            _("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫–∞—Ä—Ç: {number}",
              "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫–∞—Ä—Ç: {number}",
              n).format(number=n)
        )

        send_async(context.bot, update.message.chat_id,
                   text='\n'.join(stats_text))





def register():
    dispatcher.add_handler(CommandHandler('botrestart', botrestart))
    dispatcher.add_handler(CommandHandler('help', help_handler))
    dispatcher.add_handler(CommandHandler('source', source))
    dispatcher.add_handler(CommandHandler('news', news))
    dispatcher.add_handler(CommandHandler('stats', stats))
    dispatcher.add_handler(CommandHandler('modes', modes))
